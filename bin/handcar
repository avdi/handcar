#!/usr/bin/env ruby

require File.expand_path(
    File.join(File.dirname(__FILE__), %w[.. lib handcar]))

require 'rubygems'
require 'main'
require 'file/tail'

Main do
  PREFIX_PATTERN    = '_/_ '
  NUM_PATTERN       = '[0-9]\\+'
  MAIN_PATTERN      = ' _\\\\_ '
  HEAD_PATTERN      = MAIN_PATTERN + ' \*\* '
  STACK_PATTERN     = MAIN_PATTERN + ' >> '
  REQ_START_PATTERN = '^Processing [^ ]\+'
  REQ_END_PATTERN   = '^Completed'

  description <<-DESC
    Scrape Rails logs for traces generated with hc_trace()
  DESC

  option('trace', 't') do
    description 'Include stack traces'
    cast :bool
  end

  option('num=NUM', 'n') do
    description "Only show trace #NUM"
    cast :int
  end

  option('requests=[show_requests]', 'r') do
    description "Show requests (beginning and end)"
    default true
    cast :bool
  end

  option('follow=[follow]', 'f') do
    description "Follow log as it grows (like 'tail -f')"
    cast :bool
    default true
  end

  option('logfile=FILE', 'l') do
    description "Explicitly specify the path to the log file to scrape"
    cast :string
  end

  environment('RAILS_ENV') do
    description 'The Rails environment (determines log file to use)'
    default 'development'
  end

  def run
    file = if params[:logfile].given?
             params[:logfile].value
           else
             File.join('log', params['RAILS_ENV'].value + '.log')
           end

    filters = []

    if params[:num].given?
      filters << lambda do |trace|
        trace.number == params[:num].value
      end
    end

    unless params[:trace].value
      filters << lambda do |trace|
        trace.type == 'user'
      end
    end

    unless params[:requests].value
      filters << lambda do |trace|
        trace.type != 'request'
      end
    end

    File.open(file) do |log|
      log.extend(File::Tail)
      log.return_if_eof = (not params[:follow].value)
      catch(:quit) do
        trap("INT") do
          throw :quit
        end

        log.tail do |line|
          if Handcar::TraceLine.parseable?(line)
            begin
              trace = Handcar::TraceLine.parse(line)
              if filters.all?{|f| f.call(trace)}
                puts line
              end
            rescue ArgumentError
              # Guess it wasn't parseable after all...
              puts "<Unparseable>"
            end
          end
        end
      end
    end
    exit_success!
  end
end

# EOF
